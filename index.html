<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ESP32 Web BLE App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
</head>

<body>
<div class="topnav">
  <h1>ESP32 Web BLE Application</h1>
</div>

<div class="content">
  <div class="card-grid">
    <div class="card">
      <button id="connectBleButton" class="connectButton">Connect BLE</button>
      <button id="disconnectBleButton" class="disconnectButton">Disconnect</button>
      <p class="gray-label">
        BLE state:
        <strong><span id="bleState" style="color:#d13a30;">Disconnected</span></strong>
      </p>
    </div>
  </div>

  <div class="card-grid">
    <div class="card">
      <h2>Sensor Data</h2>
      <p class="reading">üå° Temp: <span id="tempValue">--</span> ¬∞C</p>
      <p class="reading">‚ù§Ô∏è HR: <span id="hrValue">--</span> bpm</p>
      <p class="reading">ü©∏ SpO‚ÇÇ: <span id="spo2Value">--</span> %</p>
      <p class="gray-label">Last reading: <span id="timestamp">--</span></p>
    </div>

    <div class="card">
      <h2>Control GPIO 2</h2>
      <button id="onButton" class="onButton">ON</button>
      <button id="offButton" class="offButton">OFF</button>
      <p class="gray-label">Last value sent: <span id="valueSent">--</span></p>
    </div>
  </div>
</div>

<script>
/* ========= DOM ========= */
const connectButton = document.getElementById('connectBleButton');
const disconnectButton = document.getElementById('disconnectBleButton');
const onButton = document.getElementById('onButton');
const offButton = document.getElementById('offButton');
const bleState = document.getElementById('bleState');
const tempValue = document.getElementById('tempValue');
const hrValue = document.getElementById('hrValue');
const spo2Value = document.getElementById('spo2Value');
const timestamp = document.getElementById('timestamp');
const valueSent = document.getElementById('valueSent');

/* ========= BLE UUID (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ESP32) ========= */
const SERVICE_UUID  = '19b10000-e8f2-537e-4f6c-d104768a1214';
const DATA_CHAR_UUID = '19b10001-e8f2-537e-4f6c-d104768a1214';
const LED_CHAR_UUID  = '19b10002-e8f2-537e-4f6c-d104768a1214';

let bleDevice;
let bleServer;
let bleService;
let dataCharacteristic;

/* ========= BLE CONNECT ========= */
connectButton.onclick = async () => {
  if (!navigator.bluetooth) {
    alert("Browser ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Web Bluetooth (‡πÉ‡∏ä‡πâ Chrome / Edge ‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏°)");
    return;
  }

  try {
    bleDevice = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SERVICE_UUID]
    });

    bleDevice.addEventListener('gattservicedisconnected', onDisconnected);

    bleState.innerText = "Connecting...";
    bleState.style.color = "orange";

    bleServer = await bleDevice.gatt.connect();
    bleService = await bleServer.getPrimaryService(SERVICE_UUID);
    dataCharacteristic = await bleService.getCharacteristic(DATA_CHAR_UUID);

    await dataCharacteristic.startNotifications();
    dataCharacteristic.addEventListener(
      'characteristicvaluechanged',
      handleData
    );

    bleState.innerText = "Connected";
    bleState.style.color = "#24af37";

  } catch (err) {
    console.error(err);
    alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ BLE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
};

/* ========= DISCONNECT ========= */
disconnectButton.onclick = () => {
  if (bleDevice && bleDevice.gatt.connected) {
    bleDevice.gatt.disconnect();
  }
};

function onDisconnected() {
  bleState.innerText = "Disconnected";
  bleState.style.color = "#d13a30";
}

/* ========= RECEIVE DATA ========= */
function handleData(event) {
  const text = new TextDecoder().decode(event.target.value);

  try {
    const d = JSON.parse(text);

    if (d.temp !== undefined) tempValue.innerText = d.temp.toFixed(2);
    if (d.hr   !== undefined) hrValue.innerText = d.hr.toFixed(1);
    if (d.spo2 !== undefined) spo2Value.innerText = d.spo2.toFixed(1);

    timestamp.innerText = new Date().toLocaleString();
  } catch {
    console.warn("Invalid data:", text);
  }
}

/* ========= LED CONTROL ========= */
onButton.onclick = () => writeLED(1);
offButton.onclick = () => writeLED(0);

function writeLED(val) {
  if (!bleService) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ BLE");

  bleService.getCharacteristic(LED_CHAR_UUID)
    .then(c => c.writeValue(new Uint8Array([val])))
    .then(() => valueSent.innerText = val);
}
</script>

</body>
</html>
